<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Novacool Admin Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; background:#111; color:#eee; padding:20px; }
  h2 { color:#0ff; }
  #console { background:#000; color:#0f0; padding:10px; height:250px; overflow:auto; border-radius:8px; margin-top:10px; }
  #console .error { color:#f55; }
  button, input[type=file] {
    margin:5px 0; padding:10px; border-radius:6px; border:none; background:#0ff;
    color:#000; font-weight:bold; cursor:pointer;
  }
  button:disabled { background:#555; color:#999; cursor:not-allowed; }
  #progressBar { width:100%; background:#222; border-radius:8px; overflow:hidden; height:20px; margin-top:10px; }
  #progressBar div { height:100%; background:#0f0; width:0%; transition:width 0.4s; }
  #stats { margin-top:15px; background:#222; padding:10px; border-radius:8px; }
  #stats span { color:#0ff; }
</style>
</head>
<body>
<h2>üìÅ Novacool Document Upload & Index Manager</h2>
<input type="file" id="fileInput" />
<button onclick="uploadFile()">Upload</button>
<button onclick="reindex()" id="reindexBtn">Reindex All</button>
<button onclick="resetProgress()">Reset Progress</button>
<button onclick="fetchStats()">Show Stats</button>

<div id="progressBar"><div></div></div>
<div id="stats">üìä <b>Current Stats:</b> <br>
Files: <span id="fileCount">-</span> |
Vectors: <span id="vecCount">-</span> |
Vector DB Size: <span id="vecSize">-</span>
</div>

<pre id="console"></pre>

<script>
async function uploadFile() {
  const f = document.getElementById('fileInput').files[0];
  if (!f) return alert('Please select a file.');
  const formData = new FormData();
  formData.append('file', f);
  log(`‚¨ÜÔ∏è Uploading ${f.name}...`);
  try {
    const res = await fetch('/upload', { method: 'POST', body: formData });
    const data = await res.json();
    if (res.ok) log(data.message);
    else log('‚ùå ' + data.error, true);
  } catch (e) { log('‚ùå Upload error: ' + e.message, true); }
}

async function reindex() {
  document.getElementById('reindexBtn').disabled = true;
  log('‚öôÔ∏è Starting reindex...');
  try {
    const res = await fetch('/reindex', { method: 'POST' });
    if (!res.ok) throw new Error('Server error: ' + res.status);
    log('Embedding started...');
    pollProgress();
  } catch (e) {
    log('‚ùå Reindex error: ' + e.message, true);
    document.getElementById('reindexBtn').disabled = false;
  }
}

async function resetProgress() {
  if (!confirm("Reset progress and start over?")) return;
  log('üßπ Resetting progress...');
  const res = await fetch('/reset_progress', { method: 'POST' });
  const data = await res.json();
  if (res.ok) log(data.message);
  else log('‚ùå ' + data.error, true);
}

async function fetchStats() {
  try {
    const res = await fetch('/stats');
    const s = await res.json();
    if (s.error) throw new Error(s.error);
    document.getElementById('fileCount').innerText = s.uploads;
    document.getElementById('vecCount').innerText = s.vectors;
    document.getElementById('vecSize').innerText = (s.vec_size/1024).toFixed(1) + " KB";
    log(`üìä Stats ‚Üí Files: ${s.uploads}, Vectors: ${s.vectors}, Vecs size: ${(s.vec_size/1024).toFixed(1)} KB`);
  } catch (e) {
    log('‚ùå Failed to fetch stats: ' + e.message, true);
  }
}

async function pollProgress() {
  const progressBar = document.querySelector('#progressBar div');
  const interval = setInterval(async () => {
    const res = await fetch('/progress');
    const data = await res.json();
    if (data.state === 'idle') return;
    const pct = data.total ? Math.round((data.processed / data.total) * 100) : 0;
    progressBar.style.width = pct + '%';
    log(`[${pct}%] ${data.message}`);
    if (data.state === 'done' || data.state === 'error') {
      clearInterval(interval);
      document.getElementById('reindexBtn').disabled = false;
      if (data.state === 'done') log('‚úÖ Reindex complete!');
      else log('‚ùå ' + data.message, true);
    }
  }, 3000);
}

function log(msg, err = false) {
  const c = document.getElementById('console');
  const line = document.createElement('div');
  line.textContent = msg;
  if (err) line.className = 'error';
  c.appendChild(line);
  c.scrollTop = c.scrollHeight;
}
</script>
</body>
</html>
