<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Novacool RAG Control Dashboard</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f6f9fc;
      color: #222;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
    }
    h1, h2 {
      color: #003366;
    }
    .section {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    button {
      margin: 6px;
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      background-color: #003366;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover {
      background-color: #00509e;
    }
    #progressBar, #crawlProgressBar {
      width: 100%;
      background: #eee;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
      height: 18px;
    }
    #progressFill, #crawlProgressFill {
      width: 0%;
      height: 100%;
      background: #0078d4;
      transition: width 0.3s;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    td {
      padding: 6px;
      border-bottom: 1px solid #ddd;
    }
    input[type=text] {
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>ðŸ”¥ Novacool RAG Uploader Dashboard</h1>

  <div class="section">
    <h2>ðŸ“¤ Upload Documents</h2>
    <form id="uploadForm">
      <input type="file" id="fileInput" name="files" multiple />
      <br />
      <button type="submit">Upload & Index</button>
    </form>
    <div id="progressBar"><div id="progressFill"></div></div>
    <p id="uploadStatus"></p>
  </div>

  <div class="section">
    <h2>ðŸ“Š System Status</h2>
    <table id="statusTable">
      <tr><td><b>Indexed Files</b></td><td id="indexedFiles">Loading...</td></tr>
      <tr><td><b>Upload Directory Files</b></td><td id="uploadFiles">Loading...</td></tr>
      <tr><td><b>FAISS Index Size</b></td><td id="indexSize">Loading...</td></tr>
      <tr><td><b>Last Reindex</b></td><td id="lastReindex">Loading...</td></tr>
      <tr><td><b>Crawler Active</b></td><td id="crawlerStatus">Loading...</td></tr>
    </table>
    <button id="refreshBtn">ðŸ”„ Refresh</button>
  </div>

  <div class="section">
    <h2>ðŸ•· Crawl Control Panel</h2>
    <label for="crawlUrl"><b>Base URL to crawl:</b></label>
    <input type="text" id="crawlUrl" placeholder="https://novacool.com" style="width:80%;padding:6px;margin:6px 0;">
    <div>
      <button id="btnStartCrawl">Start Crawl</button>
      <button id="btnPauseCrawl">Pause / Resume</button>
      <button id="btnStopCrawl">Stop Crawl</button>
    </div>
    <div id="crawlProgress" style="margin-top:10px;">
      <div id="crawlProgressBar">
        <div id="crawlProgressFill"></div>
      </div>
      <p id="crawlStatusText">Idle</p>
    </div>
  </div>

  <div class="section">
    <h2>ðŸ“¥ Knowledge Base</h2>
    <button id="btnManifest">Download Manifest (JSON)</button>
    <button id="btnKB">Download Knowledge Base (TXT)</button>
  </div>

  <script>
    // ------------------------
    // Upload logic
    // ------------------------
    const uploadForm = document.getElementById("uploadForm");
    const fileInput = document.getElementById("fileInput");
    const uploadStatus = document.getElementById("uploadStatus");
    const progressFill = document.getElementById("progressFill");

    uploadForm.onsubmit = async (e) => {
      e.preventDefault();
      const files = fileInput.files;
      if (!files.length) return alert("Select at least one file.");
      const formData = new FormData();
      for (let f of files) formData.append("files", f);
      uploadStatus.innerText = "Uploading...";
      progressFill.style.width = "0%";
      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/upload");
      xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
          const percent = (event.loaded / event.total) * 100;
          progressFill.style.width = percent + "%";
        }
      };
      xhr.onload = () => {
        uploadStatus.innerText = xhr.status === 200
          ? "âœ… " + JSON.parse(xhr.responseText).status
          : "âŒ Upload failed.";
        loadSystemStatus();
      };
      xhr.onerror = () => uploadStatus.innerText = "âš ï¸ Network error.";
      xhr.send(formData);
    };

    // ------------------------
    // System status logic
    // ------------------------
    async function loadSystemStatus() {
      try {
        const res = await fetch("/system_status");
        const data = await res.json();
        document.getElementById("indexedFiles").innerText = data.indexed_files;
        document.getElementById("uploadFiles").innerText = data.upload_dir_files;
        document.getElementById("indexSize").innerText = data.index_size_mb + " MB";
        document.getElementById("lastReindex").innerText = data.last_reindex;
        document.getElementById("crawlerStatus").innerText = data.crawler_active ? "ðŸŸ¢ Active" : "âšª Idle";
      } catch (err) {
        console.error("Status load error:", err);
      }
    }

    document.getElementById("refreshBtn").onclick = loadSystemStatus;
    document.getElementById("btnManifest").onclick = () => window.open("/download_manifest", "_blank");
    document.getElementById("btnKB").onclick = () => window.open("/download_kb", "_blank");
    loadSystemStatus();
    setInterval(loadSystemStatus, 30000);

    // ------------------------
    // Crawl Control Logic
    // ------------------------
    async function updateCrawlStatus() {
      try {
        const res = await fetch("/crawl_status");
        const data = await res.json();
        document.getElementById("crawlProgressFill").style.width = (data.percent || 0) + "%";
        document.getElementById("crawlStatusText").innerText = data.message || "Idle";
      } catch (err) {
        console.error("Crawl status error:", err);
      }
    }

    document.getElementById("btnStartCrawl").onclick = async () => {
      const url = document.getElementById("crawlUrl").value.trim();
      if (!url) return alert("Enter a base URL to crawl (e.g. https://novacool.com)");
      const res = await fetch("/crawl", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url })
      });
      const data = await res.json();
      document.getElementById("crawlStatusText").innerText = data.status;
      updateCrawlStatus();
    };

    document.getElementById("btnPauseCrawl").onclick = async () => {
      const res = await fetch("/pause_crawl", { method: "POST" });
      const data = await res.json();
      document.getElementById("crawlStatusText").innerText = data.status;
    };

    document.getElementById("btnStopCrawl").onclick = async () => {
      const res = await fetch("/stop_crawl", { method: "POST" });
      const data = await res.json();
      document.getElementById("crawlStatusText").innerText = data.status;
    };

    setInterval(updateCrawlStatus, 5000);
    updateCrawlStatus();
  </script>
</body>
</html>
