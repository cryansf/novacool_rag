<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Novacool RAG Control Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: system-ui, sans-serif; }
    h2 { font-size: 1.4rem; font-weight: 700; margin-bottom: 0.8rem; }
    #logConsole {
      background: #111; color: #0f0; font-family: monospace;
      height: 240px; overflow-y: scroll; border-radius: 6px; padding: 10px;
    }
    #chatResponse {
      white-space: pre-wrap;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      min-height: 100px;
    }
  </style>
</head>
<body class="p-4">
  <div class="container-fluid">
    <div class="row g-4">
      <!-- LEFT: FILE UPLOADER -->
      <div class="col-lg-4">
        <h2>üìÅ Upload Files</h2>
        <form id="uploadForm">
          <input class="form-control mb-2" type="file" id="fileInput" name="file">
          <button class="btn btn-primary w-100" type="submit">Upload</button>
        </form>
        <div id="uploadStatus" class="text-success small my-2"></div>
        <h6>üìÇ Uploaded Files (Persistent)</h6>
        <ul id="fileList" class="small"></ul>
      </div>

      <!-- MIDDLE: CRAWLER -->
      <div class="col-lg-4">
        <h2>üï∑Ô∏è Crawler Console</h2>
        <div class="input-group mb-2">
          <input type="url" id="crawlUrl" class="form-control" placeholder="Enter URL to crawl">
        </div>
        <div class="d-flex gap-2 mb-2">
          <button class="btn btn-success flex-fill" id="startCrawl">Start</button>
          <button class="btn btn-warning flex-fill" id="pauseCrawl">Pause/Resume</button>
          <button class="btn btn-danger flex-fill" id="stopCrawl">Stop</button>
          <button class="btn btn-secondary flex-fill" id="clearLogs">Clear Logs</button>
        </div>
        <div id="crawlStatus" class="small text-muted mb-2"></div>
        <h6>üìú Logs</h6>
        <pre id="logConsole"></pre>
      </div>

      <!-- RIGHT: CHAT -->
      <div class="col-lg-4">
        <h2>üí¨ Chat / Query Engine</h2>
        <div class="mb-2">
          <textarea id="chatInput" class="form-control" rows="3" placeholder="Ask about any uploaded or crawled content..."></textarea>
        </div>
        <button class="btn btn-info w-100 mb-3" id="sendChat">Send Query</button>
        <h6>Response:</h6>
        <div id="chatResponse" class="small"></div>
      </div>
    </div>
  </div>

  <script>
    const logConsole = document.getElementById("logConsole");
    const crawlStatus = document.getElementById("crawlStatus");

    // ---------- FILE UPLOAD ----------
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const file = document.getElementById("fileInput").files[0];
      if (!file) return alert("Select a file first.");
      const formData = new FormData();
      formData.append("file", file);
      const res = await fetch("/upload", { method: "POST", body: formData });
      const data = await res.json();
      document.getElementById("uploadStatus").innerText = data.message || data.error;
      loadFiles();
    });

    async function loadFiles() {
      const res = await fetch("/check_uploads");
      const data = await res.json();
      const list = document.getElementById("fileList");
      list.innerHTML = "";
      if (data.files) {
        data.files.forEach(f => {
          const li = document.createElement("li");
          li.innerHTML = `<a href="${f}" target="_blank">${f.split('/').pop()}</a>`;
          list.appendChild(li);
        });
      }
    }

    // ---------- CRAWLER ----------
    document.getElementById("startCrawl").addEventListener("click", async () => {
      const url = document.getElementById("crawlUrl").value.trim();
      if (!url) return alert("Enter a URL first.");
      const res = await fetch("/start_crawl", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url })
      });
      const data = await res.json();
      crawlStatus.innerText = data.message || data.error;
    });

    document.getElementById("pauseCrawl").addEventListener("click", async () => {
      const res = await fetch("/pause_crawl", { method: "POST" });
      const data = await res.json();
      crawlStatus.innerText = data.message;
    });

    document.getElementById("stopCrawl").addEventListener("click", async () => {
      const res = await fetch("/stop_crawl", { method: "POST" });
      const data = await res.json();
      crawlStatus.innerText = data.message;
    });

    document.getElementById("clearLogs").addEventListener("click", () => {
      logConsole.textContent = "";
    });

    async function refreshLogs() {
      const res = await fetch("/crawl_status");
      const data = await res.json();
      logConsole.textContent = data.logs.join("\n");
      logConsole.scrollTop = logConsole.scrollHeight;
    }

    // ---------- CHAT ----------
    document.getElementById("sendChat").addEventListener("click", async () => {
      const query = document.getElementById("chatInput").value.trim();
      if (!query) return alert("Enter a query first.");
      document.getElementById("chatResponse").innerText = "‚è≥ Thinking...";
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query })
      });
      const data = await res.json();
      document.getElementById("chatResponse").innerText = data.results
        ? JSON.stringify(data.results, null, 2)
        : data.error || "No response.";
    });

    setInterval(refreshLogs, 3000);
    loadFiles();
  </script>
</body>
</html>
